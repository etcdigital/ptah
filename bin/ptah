#!/usr/bin/env node
const rollup = require("rollup");
const { terser } = require("rollup-plugin-terser");
const resolve = require("@rollup/plugin-node-resolve");
const typescript = require("rollup-plugin-typescript2");
import { babel } from "@rollup/plugin-babel";
const svgr = require("@svgr/rollup").default;
const url = require("@rollup/plugin-url");
import babelConfig from "../lib/babel";
import typescriptConfig from "../lib/typescript";
import "../lib/required";

let config = {};

const configuration = {
	input: config.source,
	output: [
		{
			format: "esm",
			file: config.module,
			sourcemap: false,
			plugins: [terser()],
			exports: "named",
		},
		{
			format: "cjs",
			file: config.main,
			sourcemap: false,
			plugins: [terser()],
			exports: "named",
		},
		{
			name: config["umd:name"] || config.name,
			format: "umd",
			file: config.unpkg,
			sourcemap: false,
			plugins: [terser()],
			exports: "named",
		},
	],
	external: [
		...require("module").builtinModules,
		...Object.keys(config.dependencies || {}),
		...Object.keys(config.devDependencies || {}),
		...Object.keys(config.peerDependencies || {}),
		"react",
	],
	plugins: [
		resolve(),
		typescript(typescriptConfig),
		url(),
		svgr(),
		babel(babelConfig),
	],
};

rollup
	.rollup(configuration)
	.then((bundle) => {
		configuration.output.forEach((output) => {
			bundle.write(output);
		});
	})
	.catch((err) => {
		console.error(err);
		process.exitCode = 1;
	});
